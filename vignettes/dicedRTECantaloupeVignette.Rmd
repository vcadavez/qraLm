---
title: "QRA models functions for Diced RTE Cantaloupe"
description: >
  QRA models for frozen vegetables
author: "Vasco Cadavez, Laurent Guillier, RÃ©gis Pouillot, Moez Sanaa, Ursula Gonzales-Barron"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
     number_sections: yes
     toc: yes
vignette: >
  %\VignetteIndexEntry{QRA models functions for Diced RTE Cantaloupe}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage{caption}
  \usepackage{amssymb, amsmath}
csl: ../inst/apa.csl
bibliography: ../inst/REFERENCES.bib
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, warning = FALSE, message = FALSE,
  comment = "#>"
)
```


```{r libs, echo=FALSE}
library(Hmisc)
library(dplyr)
library(DT)
#library(rbokeh)
library(qraLm)
library(extraDistr)
library(mc2d)
library(ggplot2)
library(doseresponsemodels)
library(plotly)
#library(kableExtra)
```


## Primary production


### Parameters
```{r}
nLots=5000
sizeLot=1000

pSoil=0.089
fManure=7
pManure=0
fIrrigRaining=25
pIrrigRaining=0
cSoilLogMin=-1.0
cSoilLogMode=0.6
cSoilLogMax=1.48
qSoilMin=0.05
qSoilMode=0.5
qSoilMax=5
pFoil=1
rFoil=0.9
pIrrig=0
cIrrigLogMin=-1.52
cIrrigLogMax=1.04
cantaWeight=1000
pWaterGainMin=0.0 
pWaterGainMax=0.004 # 0.4% 
```


### Simulation
```{r}
set.seed(101)
res1<-caPrimaryProduction(nLots=nLots,
                          sizeLot=sizeLot,
                          pSoil=pSoil,
                          fManure=fManure,
                          pManure=pManure,
                          fIrrigRaining=fIrrigRaining,
                          pIrrigRaining=pIrrigRaining,
                          cSoilLogMin=cSoilLogMin,
                          cSoilLogMode= cSoilLogMode,
                          cSoilLogMax=cSoilLogMax,
                          qSoilMin=qSoilMin,
                          qSoilMode=qSoilMode,
                          qSoilMax=qSoilMax,
                          pFoil=pFoil,
                          rFoil=rFoil,
                          pIrrig=pIrrig,
                          cIrrigLogMin=cIrrigLogMin,
                          cIrrigLogMax=cIrrigLogMax,
                          cantaWeight=cantaWeight,
                          pWaterGainMin=pWaterGainMin,
                          pWaterGainMax=pWaterGainMax)
```


### Results

```{r}
str(res1)
summaryLot.qraLm(res1)
```


## Harvest and transportation to packing house

### Parameters

```{r}
probCCH    = 0.25
trMean = -1.42
trSd   = 0.52
nPlas  = 9

```


### Simulation

```{r}
set.seed(102)
res2 <- caHarvestCC (data=res1, 
                      probCCH=probCCH, 
                      trMean=trMean, 
                      trSd=trSd,
                      nPlas=nPlas,
                      nLots=nLots,
                      sizeLot=sizeLot)

```


### Results

```{r}
str(res2)
summaryLot.qraLm(res2)
```



## Choose the cantaloupe ways of preparation

### Parameters

```{r}
logDecBrushMin <- 0
logDecBrushMax <- 0

```

### Simulations

```{r}
# First brushing 
set.seed(103)
res3  <- caBrush(res2, 
                       logDecBrush = runif(nLots, 
                                             min=logDecBrushMin,
                                             max=logDecBrushMax)
                                             )

```
    

### Results

```{r}
str(res3)
summaryLot.qraLm(res3)

hist(rowSums(res3$N))
min(rowSums(res3$N))
```



## Storing


### Parameters

```{r}
p_Cooled_pp <- 0 
time_pp = 6   #previous main was run with 6 hours
shape = 0.6271
meanD410 = 1.1309
sdD410 = 1.770711e-06 
meanD25 = 2.890015
sdD25 = 0.2288748

```

### Simulations 

```{r}
set.seed(104)
res4 <- caHoldingTime(data=res3, 
                                pCooled=p_Cooled_pp, 
                                time=time_pp,
                                shape = shape,
                                meanD410 = meanD410,
                                sdD410 =sdD410, 
                                meanD25 = meanD25,
                                sdD25 = sdD25)

```

### Results

```{r}
str(res4)
summaryLot.qraLm(res4)
```


## Then washing and or sanitizing

### Parameters

```{r}
probCCW=0
logWaterMin=1
logWaterMode=1
logWaterMax=5
#cantaWeight=1000
pWaterGain=0.004
bWater=1
```


### Simulation

```{r}
set.seed(105)
res5 <- caFlumeTankCC(res4, 
         probCCW=probCCW, 
         logWaterMin=logWaterMin,
         logWaterMode=logWaterMode,
         logWaterMax=logWaterMax,
#         cantaWeight=cantaWeight,
         pWaterGain=pWaterGain,
         bWater=bWater)
```


### Results

```{r}
str(res5)
summaryLot.qraLm(res5)
```


## Dicing
  
### Parameters

```{r}
sizeSublot <- 500
cantaSurface <- 580  #cm2
cantaRindFree<- 950 #g
minTR<-0.087
modeTR <- 0.55
maxTR <- 2.82
```



### Simulation

```{r}
set.seed(106)
res6 <- caDicing(data=res5, 
                      minTR=minTR, 
                      modeTR=modeTR,
                      maxTR=maxTR,
                      cantaSurface=cantaSurface,
                      cantaRindFree=cantaRindFree,
                      nLots=nLots,
                      sizeLot=sizeLot,
                      sizeSublot=sizeSublot)

```

### Results

```{r}
str(res6)
summaryLot.qraLm(res6)
```

## Partitioning and cross-contamination 
 
### Parameters

```{r}
trDicerMean = -1.42
trDicerSd = 0.52
nDicer = 9
Pcc_dicer=0.25
b_dicer=1
unitSize = 200
```

### Simulation

```{r}
set.seed(107)
res7 <- caPartitioningCC(data=res6,
                         unitSize = unitSize,
                         probCCDice=Pcc_dicer,
                         trDicerMean=trDicerMean, 
                         trDicerSd=trDicerSd,
                         nDicer=nDicer,
                         b=b_dicer,
                         cantaRindFree=cantaRindFree,
                         newMC=nrow(res6$N)
                         )
```

### Results

```{r}
str(res7)
summaryLot.qraLm(res7)
hist(rowSums(res7$N))

```

 
## Lot tested Tested, returns as Lots
 
### Parameters

```{r}
nTested <- 5
gTested <- 25 
cTested <- 0
MTested <- 0
pLotTested <- 0
Se <- 1
backToSublot = TRUE
```


### Simulation

```{r}
set.seed(108)
res8 <- caTesting(res7,
                  nTested = nTested,
                  gTested = gTested, 
                  cTested = cTested, 
                  MTested = MTested,
                  pLotTested = pLotTested,
                  Se = Se,
                  unitSize = unitSize,
                  sizeLot = sizeLot,
                  sizeSublot = sizeSublot, 
                  backToSublot = backToSublot)

```


### Results

```{r}
str(res8)
summaryLot.qraLm(res8)
hist(rowSums(res8$N))
```



## Prevalence of contaminated units at the end of processing

```{r}
cat("overall P:", mean(res8$P * rowMeans(res8$N !=0)))

cat("overall P>10:", mean(rowMeans(res8$N/res8$unitSize >= 10))*res8$P)
cat("overall P>100:", mean(rowMeans(res8$N/res8$unitSize >= 100))*res8$P)

# assessment in mean CFU per g on a lot basis
lotBasis_Cunit <-rowMeans(res8$N/res8$unitSize) #CFU/g for every pack
NStats <- Hmisc::wtd.quantile(lotBasis_Cunit,
                              weights=rep(1,nrow(res8$N)),
                              probs=c(0,0.5,0.025,0.975,1),
                              normwt=TRUE)
NStatsMean   <- mean(lotBasis_Cunit)
NStatsMedian <- NStats[2]
Q2.5  <- NStats[3]
Q97.5 <- NStats[4]
NStatsMean
NStatsMedian
Q2.5
Q97.5
```

## Transport the lots to the retailer
  
### Parameters

```{r}
MPD=8
unitSize = 200
lnQ0Mean =-0.096728
lnQ0Sd =0.063930
meanEGR5=0.03557288
seEGR5=0.004
Tmin = -2.0196
# Temperature characteristics during transport
Temp_min_transport=3
Temp_mode_transport=5
Temp_max_transport=10.3
# Duration of the transport
t_min_transport=2
t_mode_transport=5
t_max_transport=9

```


### Simulation

```{r}
set.seed(109)
res9 <- caTrans2RetRTE(data=res8, 
                           MPD=MPD, 
                           unitSize=unitSize,
                           meanEGR5=meanEGR5,
                           seEGR5=seEGR5,
                           Tmin=Tmin,
                           tempMin=Temp_min_transport, 
                           tempMode=Temp_mode_transport, 
                           tempMax=Temp_max_transport,
                           timeMin=t_min_transport, 
                           timeMode=t_mode_transport, 
                           timeMax=t_max_transport,
                           lnQ0Mean=lnQ0Mean,
                           lnQ0Sd=lnQ0Sd)

```

### Results

```{r}
str(res9)
summaryLot.qraLm(res9)
hist(rowSums(res9$N))
min(rowSums(res9$N))
```


## Diced cantaloupe packs are stored at retail until they are sold

### Parameters

```{r}
# Temperature characteristics
Temp_min_retail=3
Temp_mode_retail=5
Temp_max_retail=10.3

# Duration of the storage at retail
t_min_retail=2
t_mode_retail=5
t_max_retail=9
```

### Simulations

```{r}
set.seed(110)
res10 <- caRetRTE(data=res9, 
#                     MPD=MPD, 
#                     Tmin=Tmin,
                     tempMin=Temp_min_retail, 
                     tempMode=Temp_mode_retail, 
                     tempMax=Temp_max_retail,
                     timeMin=t_min_retail,
                     timeMode=t_mode_retail, 
                     timeMax=t_max_retail)
```


### Results

```{r}
str(res10)
summaryLot.qraLm(res10)
hist(rowSums(res10$N))
```


## The consumers transport the packs to home


### Parameters

```{r}
Temp_min_2home=7
Temp_mode_2home=15
Temp_max_2home=30
timeShape=6.2
timeScale=8.2
```


### Simulation

```{r}
set.seed(111)
res11 <- caRet2HomeRTE(data=res10, 
#                               MPD=MPD, 
#                               Tmin=Tmin,
                               tempMin=Temp_min_2home, 
                               tempMode=Temp_mode_2home, 
                               tempMax=Temp_max_2home,
                               timeShape=timeShape,
                               timeScale=timeScale)

```


### Results

```{r}
str(res11)
summaryLot.qraLm(res11)
hist(rowSums(res11$N))
```

## Consumers store dice cantaloupe packs at home
  
### Parameters

```{r}
Temp_min_home=3.1
Temp_mode_home=6.64
Temp_max_home=11.1
t_min_home=3
t_mode_home=24
t_max_home=120
```


### Simulations

```{r}
set.seed(112)
res12<-caHomeRTE(data=res11, 
#                        MPD=MPD, 
#                        Tmin=Tmin,
                        tempMin=Temp_min_home, 
                        tempMode=Temp_mode_home, 
                        tempMax=Temp_max_home,
                        timeMin=t_min_home,
                        timeMode=t_mode_home, 
                        timeMax=t_max_home)

```


### Results

```{r}
str(res12)
summaryLot.qraLm(res12)
hist(rowSums(res12$N))

##prevalence of contaminated units at consumption
cat("overall P:", mean(res12$P * rowMeans(res12$N !=0)))

cat("overall P>10:", mean(rowMeans(res12$N/res12$unitSize >= 10))*res12$P)
cat("overall P>100:", mean(rowMeans(res12$N/res12$unitSize >= 100))*res12$P)

# assessment in CFU per gram in a contaminated serving (unit base)
CFUperServing <- (res12$N/res12$unitSize) 
index <- which(CFUperServing==0)
if (length(index)==0) {
  PosServings <- CFUperServing
} else {
  PosServings <- CFUperServing[-index]
}

NStatsMedian <- median(PosServings)
NStatsMean   <- mean(PosServings)
Q2.5  <- quantile(PosServings, probs = c(0.025))
Q97.5 <- quantile(PosServings, probs = c(0.975))
NStatsMean
NStatsMedian
Q2.5 
Q97.5
```


## Risk

### Parameters

```{r}
DRmodel <- "JEMRA"
population <- 2
```

### Simulations

```{r}
risk <- DRForModel(res12,
                   model = DRmodel,
                   population = population
)
```

### Results

#### Risk statistics between lots

```{r}
summaryLot.qraLm(risk)
```

#### Risk statistics within lots

```{r}
summaryUnits.qraLm(risk)
```

#### Risk distribution between lots

```{r}
plotRisk.qraLm(risk)
```